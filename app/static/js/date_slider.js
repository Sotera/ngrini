var data = '[{"date":"2014-02-03T06:00:00.000Z","open":100,"high":100.60032326553895,"low":99.51503064400916,"close":100.60032326553895},{"date":"2014-02-04T06:00:00.000Z","open":100.64089855069092,"high":100.64089855069092,"low":99.72086208732333,"close":100.22665430065474},{"date":"2014-02-05T06:00:00.000Z","open":100.18394531161672,"high":100.71134366138949,"low":99.73785858590273,"close":100.56894017694394},{"date":"2014-02-06T06:00:00.000Z","open":100.56840766893644,"high":101.62857917292965,"low":100.49989357115504,"close":101.62857917292965},{"date":"2014-02-07T06:00:00.000Z","open":101.78708602138724,"high":101.93257598959357,"low":101.22036955033819,"close":101.50549798276909},{"date":"2014-02-10T06:00:00.000Z","open":101.40883721431834,"high":101.99048069261434,"low":100.80558102492097,"close":101.8660496576933},{"date":"2014-02-11T06:00:00.000Z","open":101.79970614515138,"high":101.79970614515138,"low":100.87239260939499,"close":101.69995198836348},{"date":"2014-02-12T06:00:00.000Z","open":101.70694697965435,"high":101.77670367437545,"low":100.55463564529852,"close":100.93595893600923},{"date":"2014-02-13T06:00:00.000Z","open":100.80750017374727,"high":101.31447984665789,"low":100.61263117808063,"close":101.26052267753218},{"date":"2014-02-14T06:00:00.000Z","open":101.31707729878582,"high":101.73344338481374,"low":101.18402497739682,"close":101.35579330044982},{"date":"2014-02-17T06:00:00.000Z","open":101.17087556519469,"high":101.59409672558807,"low":100.80243116930276,"close":100.80243116930276},{"date":"2014-02-18T06:00:00.000Z","open":101.03375297276928,"high":101.2044731575522,"low":100.29883065887618,"close":100.60459929871537},{"date":"2014-02-19T06:00:00.000Z","open":100.5235679774476,"high":101.38217945910756,"low":100.2898323481497,"close":101.29443637434889},{"date":"2014-02-20T06:00:00.000Z","open":101.30189377999015,"high":101.86993765278716,"low":101.18186269730161,"close":101.21771324904319},{"date":"2014-02-21T06:00:00.000Z","open":101.30340705513602,"high":101.98542104035205,"low":101.1248989667707,"close":101.87408985499027},{"date":"2014-02-24T06:00:00.000Z","open":101.9134350691771,"high":102.05440901040808,"low":101.27606550306763,"close":101.29947067302878},{"date":"2014-02-25T06:00:00.000Z","open":101.21051432435894,"high":101.46983505664437,"low":100.93727445932774,"close":101.00659903406688},{"date":"2014-02-26T06:00:00.000Z","open":101.03024671951044,"high":101.26712278584401,"low":100.35657046679552,"close":101.15195454726882},{"date":"2014-02-27T06:00:00.000Z","open":101.12068127227649,"high":101.21803803735199,"low":100.57054406107704,"close":100.71493649870035},{"date":"2014-02-28T06:00:00.000Z","open":100.72631120531202,"high":101.27305789700756,"low":100.18420028920919,"close":100.33813891543956},{"date":"2014-03-03T06:00:00.000Z","open":100.54523382651357,"high":100.72277653519328,"low":99.72650557924852,"close":99.98967892746849},{"date":"2014-03-04T06:00:00.000Z","open":99.95023287519251,"high":100.64910733525609,"low":99.91107841692278,"close":100.25595332566358},{"date":"2014-03-05T06:00:00.000Z","open":100.12333741295814,"high":100.79496704641994,"low":99.8077173532729,"close":99.8077173532729},{"date":"2014-03-06T06:00:00.000Z","open":99.90832051311206,"high":100.54993620703578,"low":99.64528320635712,"close":99.88768854421107},{"date":"2014-03-07T06:00:00.000Z","open":99.94777161170988,"high":101.24628898810286,"low":99.86661666414129,"close":101.24287124399984},{"date":"2014-03-10T05:00:00.000Z","open":101.40989875514873,"high":101.6625858202218,"low":101.0155161941419,"close":101.0155161941419},{"date":"2014-03-11T05:00:00.000Z","open":101.0085527384582,"high":101.44740508235915,"low":100.7669187312939,"close":101.26141687145754},{"date":"2014-03-12T05:00:00.000Z","open":101.22882841592188,"high":101.40128751591,"low":100.61577863622827,"close":101.09141711402138},{"date":"2014-03-13T05:00:00.000Z","open":101.11956454726307,"high":101.70413972174408,"low":100.39667859005428,"close":100.44445043992476},{"date":"2014-03-14T05:00:00.000Z","open":100.42656031148745,"high":101.13853692682935,"low":100.22940399520702,"close":101.10499575523806},{"date":"2014-03-17T05:00:00.000Z","open":101.07996111395147,"high":101.38038488631858,"low":100.11265701945304,"close":100.2067350409534},{"date":"2014-03-18T05:00:00.000Z","open":100.08390620414384,"high":100.63637903308657,"low":99.83664374114284,"close":100.4833757074872},{"date":"2014-03-19T05:00:00.000Z","open":100.56780729701315,"high":101.14450444147872,"low":100.22735169083958,"close":101.09461345263834},{"date":"2014-03-20T05:00:00.000Z","open":101.22120958175869,"high":101.58065621366201,"low":101.17801226454908,"close":101.38591693850793},{"date":"2014-03-21T05:00:00.000Z","open":101.2383336138185,"high":101.38331005095954,"low":100.90375528617913,"close":100.95995522510525},{"date":"2014-03-24T05:00:00.000Z","open":100.99392380908513,"high":101.2208449127725,"low":100.58953899933321,"close":100.74291921665827},{"date":"â€¦00Z","open":106.31784868387244,"high":107.70937124064079,"low":106.31784868387244,"close":106.86319546499436},{"date":"2014-07-15T05:00:00.000Z","open":106.82145703485719,"high":106.83088687105995,"low":105.95909645008156,"close":106.68610919554791},{"date":"2014-07-16T05:00:00.000Z","open":106.67608777378341,"high":107.32660025362499,"low":106.36135818025781,"close":106.90185697361485},{"date":"2014-07-17T05:00:00.000Z","open":106.92799122537309,"high":107.11106536933914,"low":106.49533019859783,"close":106.65002448241526},{"date":"2014-07-18T05:00:00.000Z","open":106.86647816906783,"high":107.2968125904567,"low":106.63675977754357,"close":107.18375053216246},{"date":"2014-07-21T05:00:00.000Z","open":107.01192314885236,"high":107.46423982730263,"low":106.70895595531206,"close":107.34329026512427},{"date":"2014-07-22T05:00:00.000Z","open":107.33927530483896,"high":107.6373340389607,"low":107.12008739732262,"close":107.15550964882485},{"date":"2014-07-23T05:00:00.000Z","open":107.36095537065748,"high":108.74211316790364,"low":107.35450561256842,"close":108.47410905775327},{"date":"2014-07-24T05:00:00.000Z","open":108.4376335594496,"high":108.4376335594496,"low":107.15592688293287,"close":107.55615212788052},{"date":"2014-07-25T05:00:00.000Z","open":107.49806637556456,"high":107.81863728293382,"low":107.0348084825694,"close":107.63983724577469},{"date":"2014-07-28T05:00:00.000Z","open":107.67511427586747,"high":108.04833854640799,"low":106.88927566561996,"close":107.11006413305121},{"date":"2014-07-29T05:00:00.000Z","open":106.99084748092423,"high":107.30316028465033,"low":105.98996583587832,"close":105.98996583587832},{"date":"2014-07-30T05:00:00.000Z","open":106.16742092167335,"high":106.58223741397599,"low":106.03912741464657,"close":106.42552407815566},{"date":"2014-07-31T05:00:00.000Z","open":106.55492366063778,"high":106.90553539160115,"low":106.19475836503554,"close":106.37068786205805},{"date":"2014-08-01T05:00:00.000Z","open":106.37054372076855,"high":106.64100181502289,"low":105.80900138366391,"close":105.96069387329743},{"date":"2014-08-04T05:00:00.000Z","open":105.93797301511539,"high":106.69818893441173,"low":105.89478415660749,"close":106.68883245474998},{"date":"2014-08-05T05:00:00.000Z","open":106.81205470955689,"high":107.77660353114229,"low":106.74273665340787,"close":107.77660353114229},{"date":"2014-08-06T05:00:00.000Z","open":107.78699052292795,"high":108.57015835306274,"low":107.74790418551329,"close":108.29291673575538},{"date":"2014-08-07T05:00:00.000Z","open":108.31852105920711,"high":108.66745599571563,"low":107.7977392961707,"close":107.7977392961707},{"date":"2014-08-08T05:00:00.000Z","open":107.83518124608126,"high":108.29534278992148,"low":107.58972709935351,"close":107.60042934877964},{"date":"2014-08-11T05:00:00.000Z","open":107.56245183496083,"high":108.32659103337926,"low":107.11325131514347,"close":108.32659103337926},{"date":"2014-08-12T05:00:00.000Z","open":108.35091927367017,"high":108.9350552568017,"low":108.13431927775089,"close":108.58615441997705},{"date":"2014-08-13T05:00:00.000Z","open":108.69840579210623,"high":108.70563040958271,"low":107.84224283420433,"close":107.96051599036781},{"date":"2014-08-14T05:00:00.000Z","open":107.99517983370419,"high":109.45277653461021,"low":107.99517983370419,"close":109.14938959543635},{"date":"2014-08-15T05:00:00.000Z","open":109.17538574816525,"high":109.26067925153889,"low":107.85251689599257,"close":108.10199890506206},{"date":"2014-08-18T05:00:00.000Z","open":107.96146676974341,"high":108.45248758371973,"low":106.54569464929085,"close":106.63251636843756},{"date":"2014-08-19T05:00:00.000Z","open":106.7879850494658,"high":107.48398516471724,"low":106.76321357599507,"close":107.05132957576988},{"date":"2014-08-20T05:00:00.000Z","open":107.18341801566376,"high":107.18341801566376,"low":106.06788743028362,"close":106.60421358611437},{"date":"2014-08-21T05:00:00.000Z","open":106.71881983893566,"high":106.90931240986386,"low":106.18377720991982,"close":106.49650332730967},{"date":"2014-08-22T05:00:00.000Z","open":106.25133412137014,"high":106.6785897169976,"low":106.21532005869784,"close":106.49823808598873},{"date":"2014-08-25T05:00:00.000Z","open":106.47143970718312,"high":106.47143970718312,"low":105.22827216608617,"close":105.22827216608617},{"date":"2014-08-26T05:00:00.000Z","open":105.22037918676826,"high":105.32012519427066,"low":104.54900848639181,"close":105.13748081113624},{"date":"2014-08-27T05:00:00.000Z","open":105.1147921446306,"high":105.62862311746954,"low":104.83062499805517,"close":105.54110003829491},{"date":"2014-08-28T05:00:00.000Z","open":105.38200564066176,"high":105.38200564066176,"low":103.60702734625613,"close":103.60702734625613},{"date":"2014-08-29T05:00:00.000Z","open":103.72982889497375,"high":104.24126663379347,"low":103.59234118707225,"close":103.89046291729069},{"date":"2014-09-01T05:00:00.000Z","open":103.86102544050739,"high":104.67546449264373,"low":103.86102544050739,"close":103.97032911801567}]';
function dateReviver(key, value) {
 if (typeof value === 'string') {
   var a = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/.exec(value);
   if (a) {
     return new Date(Date.UTC(+a[1], +a[2] - 1, +a[3], +a[4], +a[5], +a[6]));
   }
 }
 return value;
};


data = JSON.parse(data, dateReviver)
    
    var minDate = new Date(d3.min(data, function (d) { return d.date; }).getTime() - 8.64e7);
    var maxDate = new Date(d3.max(data, function (d) { return d.date; }).getTime() + 8.64e7);
    var yMin = d3.min(data, function (d) { return d.low; });
    var yMax = d3.max(data, function (d) { return d.high; });

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // The primary chart

    // Set up the drawing area
    
    var margin = {top: 20, right: 20, bottom: 30, left: 35},
        width = 660 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    var plotChart = d3.select('#chart').classed('chart', true).append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    var plotArea = plotChart.append('g')
        .attr('clip-path', 'url(#plotAreaClip)');

    plotArea.append('clipPath')
        .attr('id', 'plotAreaClip')
        .append('rect')
        .attr({ width: width, height: height });

    // Scales

    var xScale = d3.time.scale(),
        yScale = d3.scale.linear();

    // Set scale domains
    xScale.domain([minDate, maxDate]);
    yScale.domain([yMin, yMax]).nice();

    // Set scale ranges
    xScale.range([0, width]);
    yScale.range([height, 0]);

    // Axes

    var xAxis = d3.svg.axis()
        .scale(xScale)
        .orient('bottom')
        .ticks(5);

    var yAxis = d3.svg.axis()
        .scale(yScale)
        .orient('left');

    plotChart.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,' + height + ')')
        .call(xAxis);

    plotChart.append('g')
        .attr('class', 'y axis')
        .call(yAxis);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Navigation chart

    var navWidth = width,
        navHeight = 100 - margin.top - margin.bottom;

    // Set up the drawing area

    var navChart = d3.select('#chart').classed('chart', true).append('svg')
        .classed('navigator', true)
        .attr('width', navWidth + margin.left + margin.right)
        .attr('height', navHeight + margin.top + margin.bottom)
        .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    // Scales

    var navXScale = d3.time.scale()
            .domain([
                new Date(minDate.getTime() - 8.64e7),
                new Date(maxDate.getTime() + 8.64e7)
            ])
            .range([0, navWidth]),
        navYScale = d3.scale.linear()
            .domain([yMin, yMax])
            .range([navHeight, 0]);

    // Axes

    var navXAxis = d3.svg.axis()
        .scale(navXScale)
        .orient('bottom');

    navChart.append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0,' + navHeight + ')')
        .call(navXAxis);

    // Data series

    var navData = d3.svg.area()
        .x(function (d) { return navXScale(d.date); })
        .y0(navHeight)
        .y1(function (d) { return navYScale(d.close); });

    var navLine = d3.svg.line()
        .x(function (d) { return navXScale(d.date); })
        .y(function (d) { return navYScale(d.close); });

    navChart.append('path')
        .attr('class', 'data')
        .attr('d', navData(data));

    navChart.append('path')
        .attr('class', 'line')
        .attr('d', navLine(data));

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Viewport

    var viewport = d3.svg.brush()
        .x(navXScale)
        .on("brush", function () {
            xScale.domain(viewport.empty() ? navXScale.domain() : viewport.extent());
            redrawChart();
        })
        .on("brushend", function () {
            updateZoomFromChart();
        });

    navChart.append("g")
        .attr("class", "viewport")
        .call(viewport)
        .selectAll("rect")
        .attr("height", navHeight);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Zooming and panning

    var zoom = d3.behavior.zoom()
        .x(xScale)
        .on('zoom', function() {
            if (xScale.domain()[0] < minDate) {
                zoom.translate([zoom.translate()[0] - xScale(minDate) + xScale.range()[0], 0]);
            } else if (xScale.domain()[1] > maxDate) {
                zoom.translate([zoom.translate()[0] - xScale(maxDate) + xScale.range()[1], 0]);
            }
            redrawChart();
            updateViewpointFromChart();
        });

    var overlay = d3.svg.area()
        .x(function (d) { return xScale(d.date); })
        .y0(0)
        .y1(height);

    plotArea.append('path')
        .attr('class', 'overlay')
        .attr('d', overlay(data))
	.call(zoom);

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Setup

    var daysShown = 30;

    xScale.domain([
        data[data.length - daysShown - 1].date,
        data[data.length - 1].date
    ]);

    redrawChart();
    updateViewpointFromChart();
    updateZoomFromChart();

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Helper methods

    function redrawChart() {

        plotChart.select('.x.axis').call(xAxis);
    }

    function updateViewpointFromChart() {

        if ((xScale.domain()[0] <= minDate) && (xScale.domain()[1] >= maxDate)) {

            viewport.clear();
        }
        else {

            viewport.extent(xScale.domain());
        }

        navChart.select('.viewport').call(viewport);
    }

    function updateZoomFromChart() {

        var fullDomain = maxDate - minDate,
            currentDomain = xScale.domain()[1] - xScale.domain()[0];

        var minScale = currentDomain / fullDomain,
            maxScale = minScale * 20;

        zoom.x(xScale)
            .scaleExtent([minScale, maxScale]);
    }